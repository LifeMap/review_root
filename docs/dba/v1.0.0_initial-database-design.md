# 리뷰 모으기 서비스 - 초기 데이터베이스 설계

## 문서 정보

| 항목 | 내용 |
|------|------|
| 문서명 | 초기 데이터베이스 설계 |
| 버전 | v1.0.0 |
| 작성일 | 2026-01-30 |
| 상태 | Draft |
| 기준 PRD | v1.2 (2026-01-30) |

---

## 목차

1. [개요](#1-개요)
2. [주요 엔티티 식별 및 ERD](#2-주요-엔티티-식별-및-erd)
3. [테이블 스키마 정의](#3-테이블-스키마-정의)
4. [관계 정의](#4-관계-정의)
5. [인덱싱 전략](#5-인덱싱-전략)
6. [데이터 타입 선정 근거](#6-데이터-타입-선정-근거)
7. [마이그레이션 계획](#7-마이그레이션-계획)

---

## 1. 개요

### 1.1 설계 목표

리뷰 모으기 서비스의 MVP(v1.0) 요구사항을 충족하는 데이터베이스 스키마를 설계합니다.

**핵심 요구사항:**
- 멀티 플랫폼 리뷰 통합 관리
- 광고성 리뷰 필터링
- 단점 중심 큐레이션
- 패션 카테고리 체형 프로필 기반 개인화
- 가격 비교 및 구매 링크 제공
- 사이즈 인사이트 (패션 특화)

### 1.2 설계 원칙

| 원칙 | 설명 |
|------|------|
| 확장성 | v2.0 이상 카테고리 확장을 고려한 유연한 구조 |
| 정규화 | 데이터 중복 최소화, 3NF 준수 |
| 성능 | 검색 및 필터링 성능 최적화를 위한 인덱싱 전략 |
| 보안 | 개인정보 암호화 컬럼 식별 및 마스킹 처리 |
| 유지보수성 | 명확한 네이밍 규칙 및 주석 |

### 1.3 네이밍 규칙

| 대상 | 규칙 | 예시 |
|------|------|------|
| 테이블명 | snake_case, 복수형 | `users`, `product_reviews` |
| 컬럼명 | snake_case | `user_id`, `created_at` |
| 외래키 | `{참조테이블}_id` | `user_id`, `product_id` |
| 인덱스 | `idx_{테이블}_{컬럼}` | `idx_reviews_product_id` |
| 유니크 인덱스 | `uk_{테이블}_{컬럼}` | `uk_users_email` |

---

## 2. 주요 엔티티 식별 및 ERD

### 2.1 엔티티 목록

| 엔티티명 | 설명 | 우선순위 |
|----------|------|----------|
| users | 사용자 계정 정보 | P0 |
| user_profiles | 사용자 카테고리별 프로필 (패션: 체형) | P0 |
| platforms | 쇼핑 플랫폼 정보 (29cm, 무신사, 네이버) | P0 |
| products | 상품 정보 | P0 |
| product_platform_mappings | 상품-플랫폼 매핑 (가격, URL) | P0 |
| reviews | 리뷰 정보 | P0 |
| review_analyses | 리뷰 분석 결과 (광고성, 단점 점수) | P0 |
| review_keywords | 리뷰에서 추출된 키워드 | P1 |
| product_summaries | 상품별 리뷰 요약 (장단점 Top 3) | P0 |
| size_insights | 사이즈 인사이트 (패션 특화) | P1 |
| recent_views | 최근 본 상품 | P2 |

### 2.2 ERD 다이어그램

```
┌─────────────────┐
│     users       │
├─────────────────┤
│ PK id           │
│    email        │◀──────────┐
│    password     │           │
│    unique_code  │           │
│    provider     │           │
│    ...          │           │
└─────────────────┘           │
         │ 1                  │
         │                    │
         │ N                  │
         ▼                    │
┌─────────────────┐           │
│ user_profiles   │           │
├─────────────────┤           │
│ PK id           │           │
│ FK user_id      │───────────┘
│    category     │
│    height       │
│    weight       │
│    ...          │
└─────────────────┘


┌─────────────────┐
│   platforms     │
├─────────────────┤
│ PK id           │◀──────────┐
│    name         │           │
│    code         │           │
│    ...          │           │
└─────────────────┘           │
                              │
                              │
┌─────────────────┐           │
│   products      │           │
├─────────────────┤           │
│ PK id           │◀────────┐ │
│    name         │         │ │
│    brand        │         │ │
│    category     │         │ │
│    image_url    │         │ │
│    ...          │         │ │
└─────────────────┘         │ │
         │ 1                │ │
         │                  │ │
         │ N                │ │
         ▼                  │ │
┌──────────────────────────┐│ │
│ product_platform_mappings││ │
├──────────────────────────┤│ │
│ PK id                    ││ │
│ FK product_id            │┘ │
│ FK platform_id           │──┘
│    external_id           │
│    url                   │
│    price                 │
│    ...                   │
└──────────────────────────┘
         ▲
         │
         │
         │
┌─────────────────┐
│    reviews      │
├─────────────────┤
│ PK id           │◀──────────┐
│ FK product_id   │───────┐   │
│ FK platform_id  │       │   │
│    content      │       │   │
│    rating       │       │   │
│    reviewer_name│       │   │
│    ...          │       │   │
└─────────────────┘       │   │
         │ 1              │   │
         │                │   │
         │ 1              │   │
         ▼                │   │
┌─────────────────┐       │   │
│ review_analyses │       │   │
├─────────────────┤       │   │
│ PK id           │       │   │
│ FK review_id    │───────┘   │
│    is_sponsored │           │
│    disadvantage_│           │
│    score        │           │
│    ...          │           │
└─────────────────┘           │
                              │
                              │
┌─────────────────┐           │
│ review_keywords │           │
├─────────────────┤           │
│ PK id           │           │
│ FK review_id    │───────────┘
│    keyword      │
│    type         │
│    frequency    │
│    ...          │
└─────────────────┘


┌──────────────────┐
│ product_summaries│
├──────────────────┤
│ PK id            │
│ FK product_id    │───────┐
│    pros_top3     │       │
│    cons_top3     │       │
│    ...           │       │
└──────────────────┘       │
                           │
                           │
┌──────────────────┐       │
│  size_insights   │       │
├──────────────────┤       │
│ PK id            │       │
│ FK product_id    │───────┘
│    size          │
│    purchase_rate │
│    fit_small     │
│    fit_perfect   │
│    fit_large     │
│    ...           │
└──────────────────┘


┌─────────────────┐
│  recent_views   │
├─────────────────┤
│ PK id           │
│ FK user_id      │───────────┐
│ FK product_id   │           │
│    viewed_at    │           │
└─────────────────┘           │
                              │
         (users 테이블 참조)  │
                              ▼
```

---

## 3. 테이블 스키마 정의

### 3.1 users (사용자)

사용자 계정 정보를 관리합니다.

```sql
CREATE TABLE users (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '사용자 ID',
  email VARCHAR(255) NOT NULL COMMENT '이메일 주소',
  password_hash VARCHAR(255) NULL COMMENT '비밀번호 해시 (bcrypt, 소셜 로그인 시 NULL)',
  unique_code CHAR(8) NOT NULL COMMENT '사용자 고유 코드 (A-Z0-9 랜덤 8자리)',
  provider ENUM('email', 'google', 'apple', 'kakao') NOT NULL DEFAULT 'email' COMMENT '로그인 제공자',
  provider_id VARCHAR(255) NULL COMMENT '소셜 로그인 제공자 ID',
  email_verified BOOLEAN NOT NULL DEFAULT FALSE COMMENT '이메일 인증 여부',
  email_verification_token VARCHAR(255) NULL COMMENT '이메일 인증 토큰',
  email_verification_expires_at DATETIME NULL COMMENT '이메일 인증 토큰 만료 시각',
  password_reset_token VARCHAR(255) NULL COMMENT '비밀번호 재설정 토큰',
  password_reset_expires_at DATETIME NULL COMMENT '비밀번호 재설정 토큰 만료 시각',
  last_login_at DATETIME NULL COMMENT '마지막 로그인 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',
  deleted_at DATETIME NULL COMMENT '삭제 시각 (soft delete)',

  PRIMARY KEY (id),
  UNIQUE KEY uk_users_email (email),
  UNIQUE KEY uk_users_unique_code (unique_code),
  UNIQUE KEY uk_users_provider_id (provider, provider_id),
  INDEX idx_users_email_verified (email_verified),
  INDEX idx_users_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='사용자';
```

**설계 근거:**
- `email`: 255자로 RFC 5321 표준 지원
- `password_hash`: bcrypt 해시 저장 (60자), 여유있게 255자
- `unique_code`: PRD 요구사항 (A-Z0-9 랜덤 8자리)
- `provider`: 소셜 로그인 구분 (email, google, apple, kakao)
- `email_verified`: 이메일 인증 완료 여부 확인
- `deleted_at`: Soft delete 패턴 적용 (향후 복구 가능)

---

### 3.2 user_profiles (사용자 프로필)

카테고리별 사용자 프로필 정보를 관리합니다. MVP에서는 패션 카테고리의 체형 프로필만 지원.

```sql
CREATE TABLE user_profiles (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '프로필 ID',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '사용자 ID',
  category ENUM('fashion', 'beauty', 'electronics', 'food') NOT NULL DEFAULT 'fashion' COMMENT '카테고리',

  -- 패션 프로필 (v1.0)
  height SMALLINT UNSIGNED NULL COMMENT '키 (cm, 100-220)',
  weight SMALLINT UNSIGNED NULL COMMENT '몸무게 (kg, 30-200)',
  usual_size VARCHAR(10) NULL COMMENT '평소 사이즈 (XXS~XXXXXL)',
  body_shape VARCHAR(50) NULL COMMENT '체형 특징',
  foot_size SMALLINT UNSIGNED NULL COMMENT '발 사이즈 (mm, 160-350)',
  foot_width ENUM('narrow', 'normal', 'wide') NULL COMMENT '발볼 (좁음/보통/넓음)',
  foot_arch ENUM('low', 'normal', 'high') NULL COMMENT '발등 (낮음/보통/높음)',

  -- 뷰티 프로필 (v2.0+)
  skin_type ENUM('dry', 'oily', 'combination', 'sensitive') NULL COMMENT '피부타입',
  skin_tone VARCHAR(50) NULL COMMENT '피부톤',
  skin_concerns VARCHAR(255) NULL COMMENT '피부고민 (JSON 배열)',

  -- 가전 프로필 (v2.0+)
  housing_type ENUM('apartment', 'house', 'studio', 'officetel') NULL COMMENT '주거형태',
  family_size TINYINT UNSIGNED NULL COMMENT '가구원수',
  usage_environment VARCHAR(255) NULL COMMENT '사용환경 (JSON)',

  -- 식품 프로필 (v2.0+)
  allergies VARCHAR(255) NULL COMMENT '알러지 정보 (JSON 배열)',
  diet_type VARCHAR(50) NULL COMMENT '식단 유형 (vegan, keto 등)',
  family_composition VARCHAR(100) NULL COMMENT '가족 구성',

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_user_profiles_user_category (user_id, category),
  INDEX idx_user_profiles_category (category),
  CONSTRAINT fk_user_profiles_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='사용자 프로필 (카테고리별)';
```

**설계 근거:**
- `category`: 멀티 카테고리 확장을 고려한 ENUM 타입
- `height`, `weight`: SMALLINT로 범위 최적화 (100-220cm, 30-200kg)
- `usual_size`: 사이즈 표기가 다양하여 VARCHAR(10) 사용
- `foot_size`: mm 단위로 160-350 범위 (SMALLINT)
- v2.0+ 컬럼은 NULL 허용, 향후 확장 고려
- UNIQUE KEY (user_id, category): 사용자당 카테고리별 1개 프로필만 허용

---

### 3.3 platforms (플랫폼)

쇼핑 플랫폼 정보를 관리합니다.

```sql
CREATE TABLE platforms (
  id TINYINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '플랫폼 ID',
  code VARCHAR(50) NOT NULL COMMENT '플랫폼 코드 (29cm, musinsa, naver)',
  logo_url VARCHAR(255) NULL COMMENT '로고 파일 경로',
  name VARCHAR(100) NOT NULL COMMENT '플랫폼 이름',
  url VARCHAR(255) NOT NULL COMMENT '플랫폼 URL',
  is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '활성화 여부',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_platforms_code (code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='쇼핑 플랫폼';
```

**설계 근거:**
- `id`: TINYINT (플랫폼 수가 많지 않음, 최대 255개)
- `code`: 시스템 내부에서 사용하는 고유 코드
- `logo_url`: 플랫폼 로고 이미지 경로 (NULL 허용)
- `is_active`: 플랫폼 비활성화 시 리뷰 수집 중단

---

### 3.4 products (상품)

상품 정보를 관리합니다.

```sql
CREATE TABLE products (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '상품 ID',
  name VARCHAR(500) NOT NULL COMMENT '상품명',
  brand VARCHAR(200) NOT NULL COMMENT '브랜드명',
  category ENUM('fashion', 'beauty', 'electronics', 'food') NOT NULL DEFAULT 'fashion' COMMENT '카테고리',
  sub_category VARCHAR(100) NULL COMMENT '서브 카테고리 (상의, 하의 등)',
  image_url VARCHAR(500) NULL COMMENT '상품 이미지 URL',
  description TEXT NULL COMMENT '상품 설명',
  average_rating DECIMAL(3,2) NULL COMMENT '평균 평점 (0.00-5.00)',
  total_review_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '전체 리뷰 수',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  INDEX idx_products_category (category),
  INDEX idx_products_brand (brand),
  INDEX idx_products_name (name(100)),
  INDEX idx_products_average_rating (average_rating),
  FULLTEXT INDEX ft_products_name_brand (name, brand)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='상품';
```

**설계 근거:**
- `name`: 상품명이 길 수 있어 500자
- `average_rating`: DECIMAL(3,2)로 0.00~5.00 범위 정확한 평점 저장
- `total_review_count`: 집계 성능 향상을 위한 denormalization
- FULLTEXT INDEX: 상품명, 브랜드 검색 성능 최적화

---

### 3.5 product_platform_mappings (상품-플랫폼 매핑)

동일 상품의 플랫폼별 정보(가격, URL)를 관리합니다.

```sql
CREATE TABLE product_platform_mappings (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '매핑 ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '상품 ID',
  platform_id TINYINT UNSIGNED NOT NULL COMMENT '플랫폼 ID',
  external_id VARCHAR(255) NOT NULL COMMENT '외부 플랫폼 상품 ID',
  url VARCHAR(500) NOT NULL COMMENT '상품 페이지 URL',
  price INT UNSIGNED NULL COMMENT '가격 (원)',
  original_price INT UNSIGNED NULL COMMENT '정가 (원)',
  discount_rate TINYINT UNSIGNED NULL COMMENT '할인율 (%)',
  is_available BOOLEAN NOT NULL DEFAULT TRUE COMMENT '구매 가능 여부',
  stock_status ENUM('in_stock', 'low_stock', 'out_of_stock') NOT NULL DEFAULT 'in_stock' COMMENT '재고 상태',
  price_updated_at DATETIME NULL COMMENT '가격 갱신 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_product_platform_mappings (product_id, platform_id),
  INDEX idx_product_platform_mappings_platform (platform_id),
  INDEX idx_product_platform_mappings_price (price),
  INDEX idx_product_platform_mappings_updated (price_updated_at),
  CONSTRAINT fk_product_platform_mappings_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  CONSTRAINT fk_product_platform_mappings_platform FOREIGN KEY (platform_id) REFERENCES platforms(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='상품-플랫폼 매핑 (가격 비교)';
```

**설계 근거:**
- `price`: INT로 원 단위 저장 (최대 약 21억원)
- `discount_rate`: TINYINT (0-100%)
- `stock_status`: 품절 상품 필터링을 위한 상태 관리
- `price_updated_at`: 가격 정보 신선도 확인
- UNIQUE KEY (product_id, platform_id): 상품-플랫폼 조합 중복 방지

---

### 3.6 reviews (리뷰)

수집된 리뷰 정보를 관리합니다.

```sql
CREATE TABLE reviews (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '리뷰 ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '상품 ID',
  platform_id TINYINT UNSIGNED NOT NULL COMMENT '플랫폼 ID',
  external_review_id VARCHAR(255) NOT NULL COMMENT '외부 플랫폼 리뷰 ID',
  reviewer_name VARCHAR(100) NOT NULL COMMENT '리뷰어 이름 (마스킹 처리)',
  content TEXT NOT NULL COMMENT '리뷰 내용',
  rating TINYINT UNSIGNED NOT NULL COMMENT '평점 (1-5)',
  purchase_option VARCHAR(255) NULL COMMENT '구매 옵션 (사이즈, 색상 등)',
  has_images BOOLEAN NOT NULL DEFAULT FALSE COMMENT '이미지 포함 여부',
  image_urls TEXT NULL COMMENT '리뷰 이미지 URL (JSON 배열)',

  -- 패션 카테고리 추가 정보
  reviewer_height SMALLINT UNSIGNED NULL COMMENT '리뷰어 키 (cm)',
  reviewer_weight SMALLINT UNSIGNED NULL COMMENT '리뷰어 몸무게 (kg)',
  size_feedback ENUM('small', 'perfect', 'large') NULL COMMENT '사이즈 피드백',

  reviewed_at DATETIME NOT NULL COMMENT '리뷰 작성일',
  collected_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '수집 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_reviews_platform_external (platform_id, external_review_id),
  INDEX idx_reviews_product (product_id),
  INDEX idx_reviews_rating (rating),
  INDEX idx_reviews_reviewed_at (reviewed_at),
  INDEX idx_reviews_has_images (has_images),
  INDEX idx_reviews_size_feedback (size_feedback),
  CONSTRAINT fk_reviews_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  CONSTRAINT fk_reviews_platform FOREIGN KEY (platform_id) REFERENCES platforms(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='리뷰';
```

**설계 근거:**
- `reviewer_name`: 마스킹 처리된 이름 저장 ("홍길동" → "홍*동")
- `content`: TEXT 타입으로 긴 리뷰 지원
- `image_urls`: JSON 배열로 여러 이미지 URL 저장
- `reviewer_height/weight`: 패션 카테고리 체형 매칭용
- `size_feedback`: 사이즈 인사이트 계산용
- UNIQUE KEY (platform_id, external_review_id): 중복 수집 방지

---

### 3.7 review_analyses (리뷰 분석)

AI 기반 리뷰 분석 결과를 저장합니다.

```sql
CREATE TABLE review_analyses (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '분석 ID',
  review_id BIGINT UNSIGNED NOT NULL COMMENT '리뷰 ID',
  is_sponsored BOOLEAN NOT NULL DEFAULT FALSE COMMENT '광고성 여부',
  sponsored_confidence DECIMAL(5,4) NULL COMMENT '광고성 판별 신뢰도 (0.0000-1.0000)',
  disadvantage_score INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '단점 상세도 점수',
  disadvantage_keywords TEXT NULL COMMENT '단점 키워드 (JSON 배열)',
  advantage_keywords TEXT NULL COMMENT '장점 키워드 (JSON 배열)',
  sentiment_score DECIMAL(5,4) NULL COMMENT '감성 점수 (-1.0000~1.0000)',
  analyzed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '분석 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_review_analyses_review (review_id),
  INDEX idx_review_analyses_sponsored (is_sponsored),
  INDEX idx_review_analyses_disadvantage_score (disadvantage_score),
  CONSTRAINT fk_review_analyses_review FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='리뷰 분석';
```

**설계 근거:**
- `is_sponsored`: 광고성 리뷰 필터링의 핵심 필드
- `sponsored_confidence`: AI 판별 신뢰도 (0-1), DECIMAL(5,4)로 정밀도 유지
- `disadvantage_score`: 단점 상세도 점수 (키워드 개수×10 + 단점 문자수×0.5)
- `sentiment_score`: 감성 분석 점수 (-1~1), 긍정/부정 분석용
- JSON 필드로 키워드 저장 (동적 개수 대응)

---

### 3.8 review_keywords (리뷰 키워드)

리뷰에서 추출된 키워드를 관리합니다.

```sql
CREATE TABLE review_keywords (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '키워드 ID',
  review_id BIGINT UNSIGNED NOT NULL COMMENT '리뷰 ID',
  keyword VARCHAR(100) NOT NULL COMMENT '키워드',
  type ENUM('advantage', 'disadvantage', 'neutral') NOT NULL COMMENT '키워드 타입',
  frequency TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '리뷰 내 언급 횟수',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',

  PRIMARY KEY (id),
  INDEX idx_review_keywords_review (review_id),
  INDEX idx_review_keywords_keyword (keyword),
  INDEX idx_review_keywords_type (type),
  CONSTRAINT fk_review_keywords_review FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='리뷰 키워드';
```

**설계 근거:**
- `type`: 장점/단점/중립 구분
- `frequency`: 동일 리뷰 내 키워드 반복 언급 횟수
- 별도 테이블로 분리하여 키워드 검색 및 집계 성능 향상

---

### 3.9 product_summaries (상품 요약)

상품별 리뷰 요약 정보를 저장합니다.

```sql
CREATE TABLE product_summaries (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '요약 ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '상품 ID',
  pros_top3 TEXT NOT NULL COMMENT '장점 Top 3 (JSON 배열: [{keyword, count}])',
  cons_top3 TEXT NOT NULL COMMENT '단점 Top 3 (JSON 배열: [{keyword, count}])',
  total_review_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '분석 대상 리뷰 수',
  sponsored_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '광고성 리뷰 수',
  genuine_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '진성 리뷰 수',
  average_disadvantage_score DECIMAL(8,2) NULL COMMENT '평균 단점 상세도 점수',
  generated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '요약 생성 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_product_summaries_product (product_id),
  INDEX idx_product_summaries_generated_at (generated_at),
  CONSTRAINT fk_product_summaries_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='상품 리뷰 요약';
```

**설계 근거:**
- `pros_top3`, `cons_top3`: JSON 배열로 장단점 Top 3 저장
- Denormalization: 매번 집계 연산하지 않고 사전 계산 결과 저장
- `generated_at`: 요약 신선도 확인 (1일 1회 갱신)
- 리뷰 요약 화면에서 빠른 응답 제공

---

### 3.10 size_insights (사이즈 인사이트)

패션 카테고리 전용. 사이즈별 구매 통계를 관리합니다.

```sql
CREATE TABLE size_insights (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '인사이트 ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '상품 ID',
  size VARCHAR(10) NOT NULL COMMENT '사이즈 (S, M, L 등)',
  purchase_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '해당 사이즈 구매 건수',
  purchase_rate DECIMAL(5,2) NOT NULL DEFAULT 0.00 COMMENT '구매 비율 (%, 0.00-100.00)',
  fit_small_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '작음 피드백 수',
  fit_perfect_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '적당 피드백 수',
  fit_large_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '큼 피드백 수',
  fit_small_rate DECIMAL(5,2) NOT NULL DEFAULT 0.00 COMMENT '작음 비율 (%)',
  fit_perfect_rate DECIMAL(5,2) NOT NULL DEFAULT 0.00 COMMENT '적당 비율 (%)',
  fit_large_rate DECIMAL(5,2) NOT NULL DEFAULT 0.00 COMMENT '큼 비율 (%)',
  average_height DECIMAL(5,2) NULL COMMENT '평균 키 (cm)',
  average_weight DECIMAL(5,2) NULL COMMENT '평균 몸무게 (kg)',
  generated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각',

  PRIMARY KEY (id),
  UNIQUE KEY uk_size_insights_product_size (product_id, size),
  INDEX idx_size_insights_generated_at (generated_at),
  CONSTRAINT fk_size_insights_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='사이즈 인사이트 (패션)';
```

**설계 근거:**
- `purchase_rate`, `fit_*_rate`: DECIMAL(5,2)로 퍼센트 정확도 유지
- Denormalization: 사전 집계된 통계 저장
- `average_height/weight`: 사이즈별 평균 체형 정보
- 사이즈 인사이트 화면에서 빠른 조회

---

### 3.11 recent_views (최근 본 상품)

사용자의 최근 본 상품 이력을 관리합니다.

```sql
CREATE TABLE recent_views (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '조회 이력 ID',
  user_id BIGINT UNSIGNED NOT NULL COMMENT '사용자 ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT '상품 ID',
  viewed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '조회 시각',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',

  PRIMARY KEY (id),
  INDEX idx_recent_views_user_viewed (user_id, viewed_at DESC),
  INDEX idx_recent_views_product (product_id),
  CONSTRAINT fk_recent_views_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_recent_views_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='최근 본 상품';
```

**설계 근거:**
- `viewed_at`: 조회 시각 기준 정렬
- INDEX (user_id, viewed_at DESC): 사용자별 최근 조회 이력 빠른 조회
- 중복 허용: 동일 상품을 여러 번 본 경우 각각 기록

---

## 4. 관계 정의

### 4.1 1:N 관계

| 부모 테이블 | 자식 테이블 | 관계 설명 | 외래키 제약 |
|------------|------------|----------|------------|
| users | user_profiles | 사용자 1명 → 카테고리별 프로필 N개 | CASCADE |
| users | recent_views | 사용자 1명 → 최근 본 상품 N개 | CASCADE |
| products | reviews | 상품 1개 → 리뷰 N개 | CASCADE |
| products | product_platform_mappings | 상품 1개 → 플랫폼별 매핑 N개 | CASCADE |
| products | product_summaries | 상품 1개 → 요약 1개 (1:1 관계) | CASCADE |
| products | size_insights | 상품 1개 → 사이즈별 인사이트 N개 | CASCADE |
| platforms | reviews | 플랫폼 1개 → 리뷰 N개 | RESTRICT |
| platforms | product_platform_mappings | 플랫폼 1개 → 상품 매핑 N개 | RESTRICT |
| reviews | review_analyses | 리뷰 1개 → 분석 결과 1개 (1:1 관계) | CASCADE |
| reviews | review_keywords | 리뷰 1개 → 키워드 N개 | CASCADE |

**외래키 제약 정책:**
- `CASCADE`: 부모 삭제 시 자식도 함께 삭제 (의존성 강함)
- `RESTRICT`: 자식이 존재하면 부모 삭제 불가 (참조 무결성 보호)

### 4.2 N:M 관계

현재 설계에는 순수 N:M 관계가 없습니다. 모든 다대다 관계는 중간 테이블로 해소됩니다.

**향후 확장 시 고려 사항:**
- 사용자 찜하기 (v1.1): `user_favorites` 테이블 (users ↔ products)
- 리뷰 신고 (v2.0+): `review_reports` 테이블 (users ↔ reviews)

---

## 5. 인덱싱 전략

### 5.1 인덱스 설계 원칙

| 원칙 | 설명 |
|------|------|
| 쿼리 패턴 기반 | WHERE, JOIN, ORDER BY에 자주 사용되는 컬럼 우선 인덱싱 |
| Cardinality 고려 | 고유값이 많은 컬럼 우선 (예: email, unique_code) |
| Composite Index | 다중 컬럼 조건 쿼리에 복합 인덱스 활용 |
| Covering Index | SELECT 컬럼까지 포함하여 테이블 액세스 최소화 |
| 인덱스 최소화 | 과도한 인덱스는 INSERT/UPDATE 성능 저하 |

### 5.2 주요 인덱스 목록

#### users 테이블

| 인덱스명 | 컬럼 | 타입 | 목적 |
|---------|------|------|------|
| uk_users_email | email | UNIQUE | 이메일 중복 체크, 로그인 조회 |
| uk_users_unique_code | unique_code | UNIQUE | 사용자 고유 코드 조회 |
| uk_users_provider_id | provider, provider_id | UNIQUE | 소셜 로그인 중복 방지 |
| idx_users_email_verified | email_verified | INDEX | 미인증 사용자 필터링 |

**쿼리 예시:**
```sql
-- 로그인: email로 사용자 조회
SELECT * FROM users WHERE email = 'user@example.com';

-- 소셜 로그인: provider + provider_id 조회
SELECT * FROM users WHERE provider = 'google' AND provider_id = '123456';
```

#### products 테이블

| 인덱스명 | 컬럼 | 타입 | 목적 |
|---------|------|------|------|
| idx_products_category | category | INDEX | 카테고리별 상품 필터링 |
| idx_products_brand | brand | INDEX | 브랜드별 상품 필터링 |
| idx_products_name | name(100) | INDEX | 상품명 prefix 검색 |
| ft_products_name_brand | name, brand | FULLTEXT | 전문 검색 (상품명, 브랜드 통합 검색) |
| idx_products_average_rating | average_rating | INDEX | 평점순 정렬 |

**쿼리 예시:**
```sql
-- 카테고리별 상품 조회
SELECT * FROM products WHERE category = 'fashion';

-- 전문 검색
SELECT * FROM products WHERE MATCH(name, brand) AGAINST('나이키 에어' IN NATURAL LANGUAGE MODE);

-- 평점순 정렬
SELECT * FROM products ORDER BY average_rating DESC LIMIT 10;
```

#### reviews 테이블

| 인덱스명 | 컬럼 | 타입 | 목적 |
|---------|------|------|------|
| uk_reviews_platform_external | platform_id, external_review_id | UNIQUE | 중복 수집 방지 |
| idx_reviews_product | product_id | INDEX | 상품별 리뷰 조회 |
| idx_reviews_rating | rating | INDEX | 평점 필터링 |
| idx_reviews_reviewed_at | reviewed_at | INDEX | 최신순 정렬 |
| idx_reviews_has_images | has_images | INDEX | 사진 리뷰 필터링 |
| idx_reviews_size_feedback | size_feedback | INDEX | 사이즈 피드백 필터링 |

**쿼리 예시:**
```sql
-- 상품별 리뷰 조회 (최신순)
SELECT * FROM reviews WHERE product_id = 123 ORDER BY reviewed_at DESC;

-- 평점 + 사진 필터링
SELECT * FROM reviews WHERE product_id = 123 AND rating >= 4 AND has_images = TRUE;
```

#### review_analyses 테이블

| 인덱스명 | 컬럼 | 타입 | 목적 |
|---------|------|------|------|
| uk_review_analyses_review | review_id | UNIQUE | 리뷰당 1개 분석 결과 |
| idx_review_analyses_sponsored | is_sponsored | INDEX | 광고성 리뷰 필터링 |
| idx_review_analyses_disadvantage_score | disadvantage_score | INDEX | 단점 상세순 정렬 |

**쿼리 예시:**
```sql
-- 광고성 리뷰 제외 + 단점 상세순 정렬
SELECT r.* FROM reviews r
JOIN review_analyses ra ON r.id = ra.review_id
WHERE r.product_id = 123 AND ra.is_sponsored = FALSE
ORDER BY ra.disadvantage_score DESC;
```

#### product_platform_mappings 테이블

| 인덱스명 | 컬럼 | 타입 | 목적 |
|---------|------|------|------|
| uk_product_platform_mappings | product_id, platform_id | UNIQUE | 상품-플랫폼 중복 방지 |
| idx_product_platform_mappings_platform | platform_id | INDEX | 플랫폼별 조회 |
| idx_product_platform_mappings_price | price | INDEX | 가격순 정렬 |
| idx_product_platform_mappings_updated | price_updated_at | INDEX | 가격 신선도 확인 |

**쿼리 예시:**
```sql
-- 상품의 플랫폼별 가격 비교
SELECT * FROM product_platform_mappings
WHERE product_id = 123
ORDER BY price ASC;
```

### 5.3 복합 인덱스 전략

#### user_profiles 테이블

```sql
UNIQUE KEY uk_user_profiles_user_category (user_id, category)
```

- 사용자당 카테고리별 1개 프로필만 허용
- `WHERE user_id = ? AND category = ?` 쿼리 최적화

#### recent_views 테이블

```sql
INDEX idx_recent_views_user_viewed (user_id, viewed_at DESC)
```

- 사용자별 최근 본 상품 조회 최적화
- `ORDER BY viewed_at DESC` 정렬 성능 향상
- Covering Index로 활용 가능

### 5.4 FULLTEXT 인덱스

#### products 테이블

```sql
FULLTEXT INDEX ft_products_name_brand (name, brand)
```

**사용 예시:**
```sql
-- 자연어 검색
SELECT * FROM products
WHERE MATCH(name, brand) AGAINST('나이키 에어맥스' IN NATURAL LANGUAGE MODE);

-- 불린 검색
SELECT * FROM products
WHERE MATCH(name, brand) AGAINST('+나이키 +에어맥스' IN BOOLEAN MODE);
```

**설계 근거:**
- 상품 검색 기능의 핵심 인덱스
- ngram parser 사용 권장 (한글 검색 지원)
- InnoDB FULLTEXT는 MySQL 5.6+ 지원

---

## 6. 데이터 타입 선정 근거

### 6.1 정수형 타입 선택

| 타입 | 범위 | 사용 예시 | 근거 |
|------|------|----------|------|
| TINYINT | -128 ~ 127 (UNSIGNED: 0~255) | platforms.id, reviews.rating | 플랫폼 수 적음, 평점 1-5 |
| SMALLINT | -32,768 ~ 32,767 (UNSIGNED: 0~65,535) | user_profiles.height, weight | 키/몸무게 범위 제한적 |
| INT | -2,147,483,648 ~ 2,147,483,647 | product_platform_mappings.price | 가격 (원) 최대 21억 |
| BIGINT | -9,223,372,036,854,775,808 ~ ... | users.id, products.id | PK는 BIGINT로 확장성 확보 |

**원칙:**
- PK는 BIGINT UNSIGNED (향후 대용량 데이터 대비)
- 범위가 명확한 데이터는 최소 타입 사용 (저장 공간 절약)

### 6.2 문자열 타입 선택

| 타입 | 최대 길이 | 사용 예시 | 근거 |
|------|----------|----------|------|
| CHAR(N) | 고정 N 바이트 | users.unique_code (8) | 고정 길이 문자열, 조회 성능 우수 |
| VARCHAR(N) | 가변 N 바이트 | users.email (255) | 가변 길이, 저장 공간 효율적 |
| TEXT | 최대 65,535 바이트 | reviews.content | 긴 텍스트 (리뷰 본문) |
| MEDIUMTEXT | 최대 16MB | - | v2.0+ AI 분석 결과 저장 시 고려 |

**원칙:**
- 고정 길이는 CHAR (예: unique_code, country_code)
- 가변 길이는 VARCHAR (예: email, name)
- 긴 텍스트는 TEXT (예: 리뷰 본문, 상품 설명)

### 6.3 숫자형 타입 선택

| 타입 | 정밀도 | 사용 예시 | 근거 |
|------|--------|----------|------|
| DECIMAL(M,D) | 고정 소수점 | products.average_rating (3,2) | 정확한 계산 필요 (평점, 가격 비율) |
| FLOAT / DOUBLE | 부동 소수점 | - | 근사값 허용 시 사용 (현재 미사용) |

**원칙:**
- 금액, 평점, 비율 등 정확도가 중요한 경우 DECIMAL 사용
- DECIMAL(3,2): 0.00 ~ 9.99 (평점 0.00~5.00)
- DECIMAL(5,2): 0.00 ~ 999.99 (비율 0.00%~100.00%)

### 6.4 날짜/시간 타입 선택

| 타입 | 범위 | 사용 예시 | 근거 |
|------|------|----------|------|
| DATETIME | 1000-01-01 ~ 9999-12-31 | created_at, reviewed_at | 타임존 무관, 정확한 시각 저장 |
| TIMESTAMP | 1970-01-01 ~ 2038-01-19 | - | UTC 기준 자동 변환 (현재 미사용) |

**원칙:**
- 모든 시각 데이터는 DATETIME 사용
- 타임존은 애플리케이션 레벨에서 관리
- `created_at`, `updated_at`은 DEFAULT CURRENT_TIMESTAMP

### 6.5 ENUM 타입 사용

| 테이블 | 컬럼 | ENUM 값 | 근거 |
|--------|------|---------|------|
| users | provider | email, google, apple, kakao | 로그인 제공자 제한적 |
| user_profiles | category | fashion, beauty, electronics, food | 카테고리 제한적 |
| reviews | size_feedback | small, perfect, large | 사이즈 피드백 3가지 |

**장점:**
- 저장 공간 효율적 (내부적으로 INTEGER 저장)
- 데이터 무결성 보장 (유효하지 않은 값 입력 차단)
- 가독성 향상

**단점:**
- 값 추가 시 테이블 ALTER 필요
- 확장성이 낮음

**사용 원칙:**
- 값의 종류가 고정적이고 적을 때만 사용 (10개 이하 권장)
- 자주 변경될 가능성이 있다면 별도 테이블로 분리

### 6.6 JSON 타입 고려

현재는 TEXT 타입에 JSON 문자열 저장 (MySQL 5.7+ JSON 타입 권장)

**JSON 저장 예시:**
- `review_analyses.disadvantage_keywords`: `["보풀", "늘어남", "사이즈 작음"]`
- `product_summaries.pros_top3`: `[{"keyword":"디자인 예쁨","count":45},...]`
- `reviews.image_urls`: `["https://...", "https://..."]`

**향후 JSON 타입 마이그레이션 고려:**
```sql
ALTER TABLE review_analyses MODIFY disadvantage_keywords JSON;
```

---

## 7. 마이그레이션 계획

### 7.1 초기 데이터 삽입

#### 플랫폼 데이터

```sql
INSERT INTO platforms (code, name, url, is_active) VALUES
('29cm', '29CM', 'https://www.29cm.co.kr', TRUE),
('musinsa', '무신사', 'https://www.musinsa.com', TRUE),
('naver', '네이버 스마트스토어', 'https://smartstore.naver.com', TRUE);
```

#### 초기 관리자 계정 (예시)

```sql
INSERT INTO users (email, password_hash, unique_code, provider, email_verified) VALUES
('admin@reviewservice.com', '$2b$12$...', 'ADMIN001', 'email', TRUE);
```

### 7.2 마이그레이션 순서

1. **테이블 생성 순서** (외래키 의존성 고려)
   ```
   users
   → user_profiles
   platforms
   products
   → product_platform_mappings
   → product_summaries
   → size_insights
   → reviews
      → review_analyses
      → review_keywords
   → recent_views
   ```

2. **인덱스 생성**
   - 테이블 생성과 동시에 PRIMARY KEY, UNIQUE KEY 생성
   - 일반 INDEX는 데이터 삽입 후 생성 (대량 INSERT 성능 향상)

3. **데이터 마이그레이션**
   - 초기 플랫폼 데이터 삽입
   - 초기 관리자 계정 생성
   - 크롤러를 통한 상품/리뷰 데이터 수집 시작

### 7.3 성능 최적화 설정

```sql
-- InnoDB 버퍼 풀 사이즈 (서버 메모리의 70-80%)
SET GLOBAL innodb_buffer_pool_size = 2147483648; -- 2GB

-- 쿼리 캐시 (MySQL 5.7 이하, MySQL 8.0에서는 제거됨)
-- SET GLOBAL query_cache_size = 67108864; -- 64MB

-- FULLTEXT 인덱스 ngram 토큰 사이즈 (한글 검색)
SET GLOBAL ngram_token_size = 2;

-- 타임존 설정
SET GLOBAL time_zone = '+09:00'; -- Asia/Seoul
```

### 7.4 백업 전략

| 백업 유형 | 주기 | 보관 기간 | 방법 |
|----------|------|----------|------|
| Full Backup | 일 1회 (새벽 3시) | 7일 | mysqldump 또는 Percona XtraBackup |
| Incremental Backup | 1시간 | 24시간 | Binary Log 기반 |
| 스냅샷 | 주 1회 (일요일) | 4주 | 클라우드 스토리지 백업 |

---

## 8. 보안 고려사항

### 8.1 암호화 대상 컬럼

| 테이블 | 컬럼 | 암호화 방식 | 근거 |
|--------|------|------------|------|
| users | password_hash | bcrypt (cost 12) | 비밀번호는 단방향 해싱 |
| user_profiles | height, weight | AES-256-GCM | 개인정보 보호 (체형 정보) |

**구현 방안:**
- 애플리케이션 레벨에서 암호화/복호화 처리
- 암호화 키는 환경변수로 관리 (`.env` 파일, 코드에 포함 금지)

### 8.2 개인정보 마스킹

| 테이블 | 컬럼 | 마스킹 규칙 | 예시 |
|--------|------|-----------|------|
| reviews | reviewer_name | 가운데 글자 마스킹 | "홍길동" → "홍*동" |
| users | email | 이메일 앞 3자 제외 마스킹 (로그용) | "user@example.com" → "use***@***.com" |

**구현 시점:**
- 리뷰 수집 시점에 마스킹 처리하여 저장
- 원본 데이터는 저장하지 않음

### 8.3 접근 제어

| 계정 | 권한 | 용도 |
|------|------|------|
| app_read | SELECT | 읽기 전용 (리뷰 조회, 검색) |
| app_write | SELECT, INSERT, UPDATE | 일반 애플리케이션 (회원가입, 프로필 수정) |
| crawler | SELECT, INSERT, UPDATE on products/reviews | 크롤러 전용 (리뷰 수집) |
| admin | ALL | 관리자 전용 |

**SQL 예시:**
```sql
-- 읽기 전용 계정
CREATE USER 'app_read'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON review_service.* TO 'app_read'@'%';

-- 쓰기 권한 계정
CREATE USER 'app_write'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE ON review_service.* TO 'app_write'@'%';
```

---

## 9. 향후 확장 고려사항

### 9.1 v1.1 확장 (찜하기)

```sql
CREATE TABLE user_favorites (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  product_id BIGINT UNSIGNED NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  UNIQUE KEY uk_user_favorites (user_id, product_id),
  CONSTRAINT fk_user_favorites_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_user_favorites_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 9.2 v1.2 확장 (가격 알림)

```sql
CREATE TABLE price_alerts (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  product_id BIGINT UNSIGNED NOT NULL,
  target_price INT UNSIGNED NOT NULL COMMENT '목표 가격',
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  INDEX idx_price_alerts_active (is_active),
  CONSTRAINT fk_price_alerts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_price_alerts_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 9.3 v2.0 확장 (카테고리 추가)

- `user_profiles` 테이블의 뷰티/가전/식품 프로필 컬럼 활성화
- `reviews` 테이블에 카테고리별 추가 정보 컬럼 확장
- `size_insights` 패턴을 참고하여 카테고리별 인사이트 테이블 추가

### 9.4 파티셔닝 고려 (대용량 데이터 대비)

**reviews 테이블 파티셔닝 (reviewed_at 기준)**
```sql
ALTER TABLE reviews
PARTITION BY RANGE (YEAR(reviewed_at)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p2026 VALUES LESS THAN (2027),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 10. 부록

### 10.1 전체 테이블 요약

| 테이블명 | 주요 용도 | 예상 레코드 수 (6개월) |
|----------|----------|----------------------|
| users | 사용자 계정 | 1,000 |
| user_profiles | 사용자 프로필 | 1,000 |
| platforms | 플랫폼 정보 | 3 |
| products | 상품 | 30 (플랫폼당 10개) |
| product_platform_mappings | 가격 비교 | 90 (상품당 평균 3개) |
| reviews | 리뷰 | 4,680 (상품당 평균 156개) |
| review_analyses | 리뷰 분석 | 4,680 |
| review_keywords | 키워드 | 23,400 (리뷰당 평균 5개) |
| product_summaries | 상품 요약 | 30 |
| size_insights | 사이즈 인사이트 | 150 (상품당 평균 5개 사이즈) |
| recent_views | 최근 본 상품 | 10,000 (사용자당 평균 10회) |

### 10.2 DDL 실행 순서

1. `users`
2. `user_profiles`
3. `platforms`
4. `products`
5. `product_platform_mappings`
6. `product_summaries`
7. `size_insights`
8. `reviews`
9. `review_analyses`
10. `review_keywords`
11. `recent_views`

### 10.3 주요 쿼리 예시

#### 상품 상세 페이지 조회

```sql
-- 상품 정보 + 평균 평점 + 리뷰 수
SELECT p.*, p.average_rating, p.total_review_count
FROM products p
WHERE p.id = 123;

-- 플랫폼별 가격 비교 (최저가 순)
SELECT ppm.platform_id, pl.name, ppm.price, ppm.url, ppm.is_available
FROM product_platform_mappings ppm
JOIN platforms pl ON ppm.platform_id = pl.id
WHERE ppm.product_id = 123
ORDER BY ppm.price ASC;

-- 리뷰 요약 (장단점 Top 3)
SELECT pros_top3, cons_top3, total_review_count
FROM product_summaries
WHERE product_id = 123;

-- 사이즈 인사이트
SELECT size, purchase_rate, fit_small_rate, fit_perfect_rate, fit_large_rate
FROM size_insights
WHERE product_id = 123
ORDER BY purchase_count DESC;
```

#### 리뷰 목록 조회 (광고성 제외 + 단점 상세순)

```sql
SELECT r.*, ra.disadvantage_score, ra.is_sponsored
FROM reviews r
JOIN review_analyses ra ON r.id = ra.review_id
WHERE r.product_id = 123
  AND ra.is_sponsored = FALSE
ORDER BY ra.disadvantage_score DESC
LIMIT 20 OFFSET 0;
```

#### 체형 유사도 기반 리뷰 조회

```sql
-- 사용자 프로필: 165cm, 55kg 기준
SELECT r.*,
  SQRT(POW((r.reviewer_height - 165)/10, 2) + POW((r.reviewer_weight - 55)/5, 2)) AS similarity_distance
FROM reviews r
WHERE r.product_id = 123
  AND r.reviewer_height IS NOT NULL
  AND r.reviewer_weight IS NOT NULL
HAVING similarity_distance < 5
ORDER BY similarity_distance ASC
LIMIT 20;
```

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| v1.0.0 | 2026-01-30 | 초기 데이터베이스 설계 문서 작성 | DBA |

---

**문서 끝**
